<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Proof Strategies | Mathswell</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    window.MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --primary-color: #0f766e;
            --primary-light: #10b981;
            --background: #f7faf9;
            --accent-amber: #f59e0b;
            --accent-red: #c62828;
            --text-primary: #212121;
            --text-muted: #4b5563;
            --container-bg: #ffffff;
            --border-color: #e5e7eb;
            --interactive-bg: #e6fffb;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--container-bg);
            min-height: 100vh;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* Mathswell Navigation */
        .mathswell-nav {
            display: flex;
            justify-content: center;
            margin: .4rem 0 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .mathswell-nav .mw-link {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary-color);
            padding: .3rem .7rem;
            border-radius: 999px;
            background: rgba(255,255,255,.9);
            box-shadow: 0 1px 4px rgba(0,0,0,.08);
        }
        
        .mathswell-nav .mw-link img {
            display: block;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 2rem 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--container-bg);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-button:hover:not(.active) {
            background: var(--interactive-bg);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Introduction Styles */
        .intro-section {
            max-width: 800px;
            margin: 0 auto 3rem;
        }

        .concept-explanation {
            background: var(--interactive-bg);
            border-left: 4px solid var(--primary-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .concept-explanation h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .motivation-example {
            background: var(--container-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .motivation-example h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .strategy-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 2rem 0;
        }

        @media (max-width: 768px) {
            .strategy-comparison {
                grid-template-columns: 1fr;
            }
        }

        .strategy-card {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .strategy-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .strategy-card h4 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .strategy-card .strategy-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Statement Types Styles */
        .statement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .statement-card {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .statement-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .statement-card.active {
            border-color: var(--primary-color);
            background: var(--interactive-bg);
        }

        .statement-card h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .statement-example {
            background: var(--background);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-style: italic;
        }

        .alternative-practice {
            background: var(--container-bg);
            border: 2px solid var(--accent-amber);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            text-align: center;
        }

        .alternative-practice h3 {
            color: var(--accent-amber);
            margin-bottom: 1rem;
        }

        .alternative-input {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
            align-items: center;
        }

        .alternative-input input {
            width: 100%;
            max-width: 400px;
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .alternative-input input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .check-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .alternative-input button {
            padding: 0.8rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alternative-input button:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .alternative-input button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .challenge-btn {
            background: var(--accent-amber) !important;
        }

        .challenge-btn:hover:not(:disabled) {
            background: #dc8e0a !important;
        }

        /* Builder Controls Styles */
        .builder-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        @media (max-width: 768px) {
            .builder-controls {
                grid-template-columns: 1fr;
            }
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-group select {
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            font-size: 1rem;
        }

        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .generate-btn {
            grid-column: 1 / -1;
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            justify-self: center;
            max-width: 300px;
        }

        .generate-btn:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        /* Current Problem Display */
        .current-problem {
            background: var(--interactive-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            display: none;
        }

        .current-problem.active {
            display: block;
        }

        .current-problem h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .theorem-statement {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }

        /* Strategy Selection */
        .strategy-selection {
            background: var(--container-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .strategy-selection h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .strategy-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .strategy-btn {
            padding: 1rem 1.5rem;
            background: var(--background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .strategy-btn:hover {
            border-color: var(--primary-color);
            background: var(--interactive-bg);
        }

        .strategy-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .strategy-btn .strategy-label {
            font-weight: 600;
            font-size: 1.1rem;
            display: block;
            margin-bottom: 0.3rem;
        }

        .strategy-btn small {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Alternative Practice */
        .alternative-section {
            background: var(--container-bg);
            border: 2px solid var(--accent-amber);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: none;
        }

        .alternative-section.active {
            display: block;
        }

        .alternative-section h5 {
            color: var(--accent-amber);
            margin-bottom: 1rem;
        }

        .alternative-input-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .alternative-input-group input {
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            max-width: 300px;
        }

        .alternative-input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .alternative-input-group button {
            padding: 0.8rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .alternative-input-group button:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .alternative-input-group button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .alternative-input-group .challenge-btn {
            background: var(--accent-amber) !important;
        }

        .alternative-input-group .challenge-btn:hover:not(:disabled) {
            background: #dc8e0a !important;
        }

        /* Alternative Actions */
        .alternative-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .alternative-actions button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .try-again-btn {
            background: var(--primary-color);
            color: white;
        }

        .try-again-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .hint-btn {
            background: transparent;
            color: var(--accent-amber);
            border: 2px solid var(--accent-amber) !important;
        }

        .hint-btn:hover {
            background: rgba(245, 158, 11, 0.1);
            transform: translateY(-2px);
        }

        /* Proof Structure */
        .proof-construction {
            display: none;
        }

        .proof-construction.active {
            display: block;
        }

        .proof-construction h5 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.3rem;
        }

        .proof-box {
            background: var(--container-bg);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .proof-box.assumption {
            border-color: var(--accent-amber);
            background: rgba(245, 158, 11, 0.05);
        }

        .proof-box.steps-container {
            border-color: var(--border-color);
            background: var(--background);
        }

        .proof-box.contradiction {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.05);
        }

        .proof-box.conclusion {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .proof-box.given {
            border-color: var(--primary-color);
            background: rgba(15, 118, 110, 0.05);
        }

        .box-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .statement-display {
            font-size: 1.1rem;
            padding: 0.8rem;
            background: white;
            border-radius: 6px;
            text-align: center;
        }

        .sortable-area {
            min-height: 200px;
            padding: 1rem;
            background: white;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
        }

        .proof-step {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }

        .proof-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .proof-step.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .proof-step.correct {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        /* Proof Controls */
        .proof-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn.hint {
            background: var(--accent-amber);
            color: white;
        }

        .control-btn.hint:hover {
            background: #dc8e0a;
            transform: translateY(-2px);
        }

        .control-btn.check {
            background: var(--primary-color);
            color: white;
        }

        .control-btn.check:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .control-btn.reset {
            background: var(--accent-red);
            color: white;
        }

        .control-btn.reset:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* Feedback Display */
        .feedback-display {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .feedback-display.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .feedback-display.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }

        .feedback-display.info {
            background: var(--interactive-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        /* Complete Proof Display */
        .complete-proof {
            background: linear-gradient(135deg, #fff, var(--interactive-bg));
            border: 3px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 8px 32px rgba(15, 118, 110, 0.15);
            display: none;
            animation: slideIn 0.6s ease;
        }

        .complete-proof.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .complete-proof h5 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .proof-content {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
        }

        .proof-content p {
            margin-bottom: 1rem;
        }

        .qed {
            text-align: right;
            font-size: 1.2rem;
            margin-top: 1rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .nav-btn {
            padding: 0.8rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        /* Key Insights */
        .key-insights {
            background: var(--container-bg);
            border: 2px solid var(--accent-amber);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .key-insights h4 {
            color: var(--accent-amber);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .insight-item {
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid var(--accent-amber);
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        /* Warning Notice */
        .warning-notice {
            background: rgba(251, 191, 36, 0.1);
            color: #92400e;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-amber);
            animation: fadeIn 0.5s ease;
        }

        /* Attempt Counter */
        .attempt-counter {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Show Answer Button */
        .show-answer-btn {
            background: transparent !important;
            color: var(--primary-color) !important;
            border: 1px solid var(--primary-color) !important;
            font-size: 0.9rem !important;
            padding: 0.6rem 1.2rem !important;
            margin-left: 0.5rem;
        }

        .show-answer-btn:hover:not(:disabled) {
            background: var(--interactive-bg) !important;
        }

        /* Improved Feedback Sections */
        .feedback-section {
            margin-bottom: 1rem;
        }

        .feedback-section strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .hint-progression {
            background: rgba(245, 158, 11, 0.1);
            padding: 0.8rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            border-left: 3px solid var(--accent-amber);
        }

        .correct-answer-reveal {
            background: rgba(16, 185, 129, 0.1);
            padding: 0.8rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            border: 2px solid var(--success-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mathswell Navigation Badge -->
        <div class="mathswell-nav">
            <a href="https://mathswell.com" class="mw-link">
                <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
                <span>MATHSWELL</span>
            </a>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>Proof Strategies</h1>
            <p class="subtitle">Master direct and indirect proof approaches through interactive exploration</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" data-tab="introduction">Introduction</button>
            <button class="tab-button" data-tab="alternatives">Statement Types</button>
            <button class="tab-button" data-tab="builder">Proof Builder</button>
        </div>

        <!-- Introduction Tab -->
        <div id="introduction" class="tab-content active">
            <div class="intro-section">
                <div class="concept-explanation">
                    <h3>What are Proof Strategies?</h3>
                    <p>When proving mathematical statements, you have two fundamental approaches: <strong>direct proof</strong> (work forward from what you know) or <strong>indirect proof</strong> (assume the opposite and find a contradiction). The key skill is recognizing which approach works best for your specific statement.</p>
                </div>

                <div class="motivation-example">
                    <h4>üîç Motivation: The Power of Elimination</h4>
                    <p><strong>Scenario:</strong> There are three doors. You know there's a goat behind exactly one of them.</p>
                    <p style="margin: 1rem 0;">You open the first door - no goat. You open the second door - no goat.</p>
                    <p><strong>Conclusion:</strong> The goat must be behind the third door.</p>
                    <p style="margin: 1rem 0;"><em>You don't need to open the third door to prove this!</em> By systematically eliminating the other possibilities, you've established the truth with certainty.</p>
                    <p style="margin-top: 1rem;">This elimination strategy scales down beautifully: What if there were only <strong>two doors</strong>? Open one (no goat) ‚Üí the goat must be behind the other. This is exactly how <strong>proof by contradiction</strong> works: every mathematical statement is either "true" or "false" - eliminate "false" and you've proven "true".</p>
                </div>

                <div class="strategy-comparison">
                    <div class="strategy-card">
                        <span class="strategy-icon">üéØ</span>
                        <h4>Direct Proof</h4>
                        <p><strong>When:</strong> You can build a clear logical path from assumptions to conclusion</p>
                        <p><strong>How:</strong> Start with what you know, apply definitions and theorems, work step-by-step to your goal</p>
                        <p><strong>Example:</strong> "If n is even, then n¬≤ is even" - use definition of even numbers directly</p>
                    </div>

                    <div class="strategy-card">
                        <span class="strategy-icon">üîÑ</span>
                        <h4>Proof by Contradiction</h4>
                        <p><strong>When:</strong> Direct proof seems difficult, or the statement involves "not existing" or irrationality</p>
                        <p><strong>How:</strong> Assume the opposite of what you want to prove, derive an impossible consequence</p>
                        <p><strong>Example:</strong> "‚àö2 is irrational" - assume it's rational and find contradiction</p>
                    </div>
                </div>

                <div class="key-insights">
                    <h4>üéØ The Real Challenge</h4>
                    <div class="insight-item">
                        <div class="insight-title">Identifying the Alternative:</div>
                        <div>The hardest part of proof by contradiction isn't finding the contradiction - it's figuring out exactly what to assume! Different statement types have different negations.</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">Strategic Thinking:</div>
                        <div>Ask yourself: "What would I assume for contradiction?" If that assumption gives you concrete properties to work with, contradiction might be your best path.</div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="switchTab('alternatives')">Learn Statement Types ‚Üí</button>
                    <button class="nav-btn" onclick="switchTab('builder')">Try Proof Builder ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Statement Types & Alternatives Tab -->
        <div id="alternatives" class="tab-content">
            <div class="intro-section">
                <div class="concept-explanation">
                    <h3>Mastering Alternatives: What Do You Assume for Contradiction?</h3>
                    <p>Different types of mathematical statements have different negations. This is crucial for proof by contradiction - you need to know exactly what to assume!</p>
                </div>

                <div class="statement-grid">
                    <div class="statement-card active" data-type="bare" onclick="showStatementType('bare', this)">
                        <h4>Bare Statement (P)</h4>
                        <div class="statement-example">
                            <strong>Example:</strong> "‚àö2 is irrational"
                        </div>
                        <p><strong>Alternative:</strong> Assume ¬¨P</p>
                        <p><strong>For contradiction:</strong> Assume "‚àö2 is rational"</p>
                    </div>

                    <div class="statement-card" data-type="implication" onclick="showStatementType('implication', this)">
                        <h4>Implication (P ‚Üí Q)</h4>
                        <div class="statement-example">
                            <strong>Example:</strong> "If n is even, then n¬≤ is even"
                        </div>
                        <p><strong>Alternative:</strong> Assume P ‚àß ¬¨Q</p>
                        <p><strong>For contradiction:</strong> Assume "n is even but n¬≤ is odd"</p>
                    </div>

                    <div class="statement-card" data-type="universal" onclick="showStatementType('universal', this)">
                        <h4>Universal Statement (‚àÄx P(x))</h4>
                        <div class="statement-example">
                            <strong>Example:</strong> "All primes > 2 are odd"
                        </div>
                        <p><strong>Alternative:</strong> Find x where ¬¨P(x)</p>
                        <p><strong>For contradiction:</strong> Find "a prime > 2 that is even"</p>
                    </div>

                    <div class="statement-card" data-type="existence" onclick="showStatementType('existence', this)">
                        <h4>Existence Statement (‚àÉx P(x))</h4>
                        <div class="statement-example">
                            <strong>Example:</strong> "There exists an irrational number"
                        </div>
                        <p><strong>Alternative:</strong> Assume ‚àÄx ¬¨P(x)</p>
                        <p><strong>For contradiction:</strong> Assume "all numbers are rational"</p>
                    </div>
                </div>

                <div class="alternative-practice">
                    <h3>Practice: Identify the Alternative</h3>
                    <div id="practice-statement">
                        Click a statement type above to see a practice problem!
                    </div>
                    <div class="alternative-input">
                        <input type="text" id="alternative-input" placeholder="What would you assume for contradiction?" disabled>
                        <div class="check-options">
                            <button id="check-alternative" onclick="checkAlternative()" disabled>Quick Check</button>
                            <button id="challenge-ai" onclick="challengeAI()" disabled class="challenge-btn">Challenge AI</button>
                        </div>
                    </div>
                    <div id="alternative-feedback" class="feedback-display" style="display: none;"></div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="switchTab('builder')">Apply in Proof Builder ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Proof Builder Tab -->
        <div id="builder" class="tab-content">
            <div class="intro-section">
                <div class="concept-explanation">
                    <h3>Interactive Proof Builder</h3>
                    <p>Generate dynamic proof problems with AI assistance. Choose your strategic approach, identify key assumptions, then construct the full proof step by step.</p>
                    <p style="font-size: 0.9rem; font-style: italic; color: var(--text-muted); margin-top: 1rem; opacity: 0.9;">
                        <strong>Note:</strong> The AI helper can make mistakes and may be temporarily unavailable during periods of high traffic.
                    </p>
                </div>

                <div class="builder-controls">
                    <div class="control-group">
                        <label for="statement-type">Statement Type</label>
                        <select id="statement-type">
                            <option value="bare">Bare Statement</option>
                            <option value="implication">Implication</option>
                            <option value="universal">Universal Statement</option>
                            <option value="existence">Existence Statement</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="subject-area">Subject Area</label>
                        <select id="subject-area">
                            <option value="number-theory">Number Theory</option>
                            <option value="geometry">Geometry</option>
                            <option value="algebra">Algebra</option>
                            <option value="analysis">Real Analysis</option>
                        </select>
                    </div>
                    <button class="generate-btn" onclick="generateProblem()">
                        Generate Problem with AI
                    </button>
                </div>

                <div id="current-problem" class="current-problem">
                    <h4>Current Problem</h4>
                    <div id="theorem-text" class="theorem-statement"></div>
                    
                    <!-- Step 1: Strategy Selection -->
                    <div class="strategy-selection">
                        <h5>Step 1: Choose Your Proof Strategy</h5>
                        <p>Which approach seems more promising for this statement?</p>
                        <div class="strategy-buttons">
                            <button class="strategy-btn" onclick="selectBuilderStrategy('direct')">
                                <span class="strategy-label">üéØ Direct Proof</span>
                                <small>Work forward from assumptions</small>
                            </button>
                            <button class="strategy-btn" onclick="selectBuilderStrategy('contradiction')">
                                <span class="strategy-label">üîÑ Proof by Contradiction</span>
                                <small>Assume the opposite</small>
                            </button>
                        </div>
                        <div id="strategy-feedback" class="feedback-display" style="display: none;"></div>
                    </div>

                    <!-- Step 2: Alternative (for contradiction only) -->
                    <div id="alternative-section" class="alternative-section">
                        <h5>Step 2: Identify What to Assume</h5>
                        <p>What would you assume for proof by contradiction?</p>
                        <div class="alternative-input-group">
                            <input type="text" id="builder-alternative-input" placeholder="Enter what you would assume...">
                            <button id="quick-check-btn" onclick="checkBuilderAlternative()">Quick Check</button>
                        </div>
                        <div id="builder-alternative-feedback" class="feedback-display" style="display: none;"></div>
                        <div id="alternative-actions" class="alternative-actions" style="display: none;">
                            <button onclick="checkBuilderAlternative()" class="try-again-btn">Try Again</button>
                            <button onclick="getStructuredHint()" class="hint-btn">Get Hint</button>
                            <button onclick="challengeAIBuilder()" class="challenge-btn">Challenge AI</button>
                            <button id="show-answer-btn" onclick="showBuilderAnswer()" class="show-answer-btn" style="display: none;">Show Answer</button>
                            <button id="continue-btn" onclick="proceedWithProof()" class="nav-btn" style="display: none;">Continue to Proof ‚Üí</button>
                        </div>
                    </div>

                    <!-- Proof Construction -->
                    <div id="proof-construction" class="proof-construction">
                        <h5 id="construction-title">Construct the Proof</h5>
                        
                        <div id="proof-structure">
                            <!-- Structure will be built dynamically here -->
                        </div>

                        <div class="proof-controls">
                            <button class="control-btn hint" onclick="showHint()">üí° Hint</button>
                            <button class="control-btn check" onclick="checkProof()">‚úÖ Check Proof</button>
                            <button class="control-btn reset" onclick="resetProof()">üîÑ Reset</button>
                        </div>

                        <div id="proof-feedback" class="feedback-display" style="display: none;"></div>

                        <div id="complete-proof" class="complete-proof">
                            <h5>‚ú® Complete Proof</h5>
                            <div id="proof-content" class="proof-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// State management
let state = {
    currentStatementType: 'bare',
    currentProblem: null,
    selectedStrategy: null,
    draggedElement: null,
    originalStepsOrder: [],
    attemptCounts: {
        alternatives: {},
        builder: 0
    },
    practiceProblems: {
        bare: {
            statement: "‚àö2 is irrational",
            alternative: "‚àö2 is rational",
            variations: ["sqrt 2 is rational", "assume ‚àö2 rational", "root 2 is rational", "square root of 2 is rational"]
        },
        implication: {
            statement: "If n is even, then n¬≤ is even",
            alternative: "n is even but n¬≤ is odd",
            variations: ["n even and n¬≤ odd", "n is even but n squared is odd", "assume n even but n¬≤ not even", "n even and n¬≤ not even"]
        },
        universal: {
            statement: "Every prime number greater than 2 is odd",
            alternative: "There exists a prime number greater than 2 that is even",
            variations: ["some prime > 2 is even", "find an even prime > 2", "exists even prime greater than 2", "some prime greater than 2 is even"]
        },
        existence: {
            statement: "There exists an irrational number",
            alternative: "All numbers are rational",
            variations: ["no irrational numbers exist", "assume all numbers rational", "every number is rational", "no numbers are irrational"]
        }
    }
};

// Sample problems for builder (fallback when AI is unavailable)
const sampleProblems = {
    'bare-number-theory': {
        statement: "‚àö3 is irrational",
        alternative: "‚àö3 is rational",
        preferredStrategy: "contradiction",
        hint: "Assume ‚àö3 = p/q in lowest terms, then show both p and q must be divisible by 3.",
        directProof: {
            assumption: "We need to prove ‚àö3 is irrational",
            conclusion: "Therefore ‚àö3 is irrational"
        },
        contradictionProof: {
            assumption: "Assume ‚àö3 is rational, so ‚àö3 = p/q where gcd(p,q) = 1",
            contradiction: "But gcd(p,q) = 1 and both p and q are divisible by 3 - Contradiction!"
        },
        steps: [
            "Square both sides: 3 = p¬≤/q¬≤",
            "Multiply by q¬≤: 3q¬≤ = p¬≤",
            "Since p¬≤ is divisible by 3, p must be divisible by 3. Let p = 3k",
            "Substitute: 3q¬≤ = (3k)¬≤ = 9k¬≤",
            "Simplify: q¬≤ = 3k¬≤",
            "Since q¬≤ is divisible by 3, q must be divisible by 3"
        ]
    },
    'existence-number-theory': {
        statement: "There exists a prime number between 10 and 20",
        alternative: "There is no prime number between 10 and 20",
        preferredStrategy: "direct",
        hint: "To prove existence, you just need to find one example. Check if 11, 13, 17, or 19 are prime.",
        directProof: {
            assumption: "We need to prove there exists a prime between 10 and 20",
            conclusion: "Therefore, there exists a prime number between 10 and 20"
        },
        contradictionProof: {
            assumption: "Assume there is no prime number between 10 and 20",
            contradiction: "But 11 is prime and 10 < 11 < 20 - Contradiction!"
        },
        steps: [
            "Consider the number 11, which is between 10 and 20",
            "Check if 11 has any divisors other than 1 and itself",
            "11 is not divisible by 2 (it's odd)",
            "11 is not divisible by 3 (11 = 3√ó3 + 2)",
            "We only need to check up to ‚àö11 ‚âà 3.3, so we've checked all necessary divisors",
            "Since 11 has no divisors other than 1 and 11, it is prime"
        ]
    },
    'existence-algebra': {
        statement: "There exists a real number $x$ such that $x^2 - 5x + 6 = 0$",
        alternative: "For all real numbers $x$, $x^2 - 5x + 6 ‚â† 0$",
        preferredStrategy: "direct",
        hint: "Factor the quadratic: $x^2 - 5x + 6 = (x-2)(x-3)$",
        directProof: {
            assumption: "We need to find a real number $x$ such that $x^2 - 5x + 6 = 0$",
            conclusion: "Therefore, there exists a real number $x$ satisfying the equation"
        },
        contradictionProof: {
            assumption: "Assume for all real $x$, $x^2 - 5x + 6 ‚â† 0$",
            contradiction: "But $x = 2$ gives $4 - 10 + 6 = 0$ - Contradiction!"
        },
        steps: [
            "Factor the quadratic: $x^2 - 5x + 6 = (x-2)(x-3)$",
            "Set each factor equal to zero: $x-2 = 0$ or $x-3 = 0$",
            "Solve: $x = 2$ or $x = 3$",
            "Verify with $x = 2$: $2^2 - 5(2) + 6 = 4 - 10 + 6 = 0$ ‚úì",
            "Verify with $x = 3$: $3^2 - 5(3) + 6 = 9 - 15 + 6 = 0$ ‚úì",
            "Both $x = 2$ and $x = 3$ are real numbers that satisfy the equation"
        ]
    }
};

// DOM references
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

// Initialize
function init() {
    setupTabs();
    showStatementType('bare', document.querySelector('[data-type="bare"]'));
}

// Tab switching
function setupTabs() {
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            switchTab(tabId);
        });
    });
}

function switchTab(tabId) {
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// Statement type exploration (Tab 2)
function showStatementType(type, element) {
    // Update active state
    document.querySelectorAll('.statement-card').forEach(card => {
        card.classList.remove('active');
    });
    element.classList.add('active');
    
    state.currentStatementType = type;
    state.attemptCounts.alternatives[type] = 0;
    const problem = state.practiceProblems[type];
    
    document.getElementById('practice-statement').innerHTML = `
        <strong>Practice Statement:</strong> ${problem.statement}
    `;
    
    // Enable both buttons
    document.getElementById('alternative-input').disabled = false;
    document.getElementById('check-alternative').disabled = false;
    document.getElementById('challenge-ai').disabled = false;
    document.getElementById('alternative-input').placeholder = "What would you assume for contradiction?";
    document.getElementById('alternative-input').value = "";
    document.getElementById('alternative-feedback').style.display = 'none';
    
    // Typeset math if available
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([document.getElementById('practice-statement')]);
    }
}

function checkAlternative() {
    const userInput = document.getElementById('alternative-input').value.toLowerCase().trim();
    const problem = state.practiceProblems[state.currentStatementType];
    const correctAlternative = problem.alternative.toLowerCase();
    const variations = problem.variations.map(v => v.toLowerCase());
    
    const feedbackDiv = document.getElementById('alternative-feedback');
    feedbackDiv.style.display = 'block';
    
    state.attemptCounts.alternatives[state.currentStatementType] = 
        (state.attemptCounts.alternatives[state.currentStatementType] || 0) + 1;
    
    const attemptCount = state.attemptCounts.alternatives[state.currentStatementType];
    
    // More flexible checking
    let isCorrect = false;
    let isPartiallyCorrect = false;
    let feedback = '';
    
    if (userInput === '') {
        feedbackDiv.className = 'feedback-display info';
        feedbackDiv.innerHTML = '<strong>Please enter your answer first!</strong>';
        return;
    }
    
    // Check for exact or close matches
    const normalizedInput = userInput.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
    const normalizedCorrect = correctAlternative.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
    
    if (normalizedInput === normalizedCorrect || 
        variations.some(v => normalizedInput.includes(v.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim()))) {
        isCorrect = true;
    }
    
    // Check for partial understanding based on statement type
    else if (state.currentStatementType === 'implication') {
        if (userInput.includes('but') || userInput.includes('and') || userInput.includes('however')) {
            if (userInput.includes('not') || userInput.includes('odd')) {
                isPartiallyCorrect = true;
                feedback = "You're on the right track! For an implication P‚ÜíQ, the negation is 'P is true AND Q is false'. Try to be more specific about both parts.";
            }
        }
    }
    else if (state.currentStatementType === 'universal') {
        if (userInput.includes('exists') || userInput.includes('some') || userInput.includes('find')) {
            isPartiallyCorrect = true;
            feedback = "Good! You recognize that the negation of 'all' is 'some' or 'exists'. Can you be more specific about what we're looking for?";
        }
    }
    else if (state.currentStatementType === 'existence') {
        if (userInput.includes('all') || userInput.includes('no') || userInput.includes('every')) {
            isPartiallyCorrect = true;
            feedback = "Right direction! The negation of 'there exists' is 'for all' or 'none'. Try to complete the statement.";
        }
    }
    else if (state.currentStatementType === 'bare') {
        if (userInput.includes('rational') || userInput.includes('finite') || userInput.includes('opposite')) {
            isPartiallyCorrect = true;
            feedback = "You're thinking about the opposite, which is good! Can you state it more precisely?";
        }
    }
    
    // Display appropriate feedback with attempt tracking
    if (isCorrect) {
        feedbackDiv.className = 'feedback-display success';
        feedbackDiv.innerHTML = `
            <strong>Excellent!</strong><br>
            The alternative is: "${problem.alternative}"<br>
            This gives you something concrete to work with for contradiction.
        `;
    } else if (isPartiallyCorrect) {
        feedbackDiv.className = 'feedback-display info';
        let html = `
            <div class="feedback-section">
                <strong>You're getting closer!</strong>
                ${feedback}
            </div>
        `;
        
        if (attemptCount >= 2) {
            html += `
                <div class="hint-progression">
                    <strong>Hint:</strong> The complete alternative is: "${problem.alternative}"
                    <div class="attempt-counter">Attempts: ${attemptCount}</div>
                </div>
            `;
        } else {
            html += `<div class="attempt-counter">Attempts: ${attemptCount}</div>`;
        }
        
        feedbackDiv.innerHTML = html;
    } else {
        feedbackDiv.className = 'feedback-display info';
        let html = getHelpfulHintAlternatives(state.currentStatementType, problem);
        
        if (attemptCount >= 3) {
            html += `
                <button class="show-answer-btn" onclick="showAlternativeAnswer()">Show Answer</button>
                <div class="attempt-counter">Attempts: ${attemptCount}</div>
            `;
        } else {
            html += `<div class="attempt-counter">Attempts: ${attemptCount}</div>`;
        }
        
        feedbackDiv.innerHTML = html;
    }
    
    // Typeset math if available
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([feedbackDiv]);
    }
}

function showAlternativeAnswer() {
    const problem = state.practiceProblems[state.currentStatementType];
    const feedbackDiv = document.getElementById('alternative-feedback');
    
    feedbackDiv.className = 'feedback-display success';
    feedbackDiv.innerHTML = `
        <div class="correct-answer-reveal">
            <strong>The correct alternative is:</strong><br>
            "${problem.alternative}"<br><br>
            Understanding this negation is crucial for proof by contradiction. 
            Try another statement type to practice more!
        </div>
    `;
    
    // Typeset math if available
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([feedbackDiv]);
    }
}

function getHelpfulHintAlternatives(type, problem) {
    const hints = {
        'bare': `<strong>Think step by step:</strong><br>
                To negate "${problem.statement}", consider: what would be the opposite?<br>
                <small>Hint: If something is irrational, its opposite would be...?</small>`,
                
        'implication': `<strong>For if-then statements:</strong><br>
                       To negate "If P, then Q", you need "P is true AND Q is false"<br>
                       <small>Think: "${problem.statement.split(',')[0]}" is true, but the conclusion fails.</small>`,
                       
        'universal': `<strong>For "all" statements:</strong><br>
                     To negate "For all x, P(x)", you need "There exists some x where P(x) is false"<br>
                     <small>What specific counterexample would you look for?</small>`,
                     
        'existence': `<strong>For "there exists" statements:</strong><br>
                     To negate "There exists x such that P(x)", you need "For all x, P(x) is false"<br>
                     <small>You're saying no such thing exists anywhere.</small>`
    };
    
    return hints[type] || 'Try thinking about what the logical opposite would be.';
}

async function challengeAI() {
    const userInput = document.getElementById('alternative-input').value.trim();
    const problem = state.practiceProblems[state.currentStatementType];
    const feedbackDiv = document.getElementById('alternative-feedback');
    const challengeBtn = document.getElementById('challenge-ai');
    
    if (userInput === '') {
        feedbackDiv.style.display = 'block';
        feedbackDiv.className = 'feedback-display info';
        feedbackDiv.innerHTML = '<strong>Please enter your answer first!</strong>';
        return;
    }
    
    challengeBtn.disabled = true;
    challengeBtn.textContent = 'AI Analyzing...';
    
    try {
        const typeExplanations = {
            'bare': 'a bare statement (just P)',
            'implication': 'an implication statement (if P then Q)',
            'universal': 'a universal statement (for all x, P(x))',
            'existence': 'an existence statement (there exists x such that P(x))'
        };
        
        const prompt = `You are a supportive mathematics tutor helping a student learn proof by contradiction. The student is working on identifying negations.

Statement type: ${typeExplanations[state.currentStatementType]}
Original statement: "${problem.statement}"
Student's proposed negation: "${userInput}"
Correct negation: "${problem.alternative}"

Provide guided feedback following these rules:
1. If completely correct: Celebrate and reinforce their understanding
2. If partially correct: Identify what they got right, then give a specific hint about what's missing WITHOUT revealing the answer
3. If incorrect: Give an encouraging hint that guides them toward the logical structure WITHOUT giving away the answer

Use LaTeX notation with $ for inline math where appropriate.
Be encouraging and specific. Focus on helping them discover the answer themselves.
Keep response to 2-3 sentences maximum.

Important: Do NOT directly state the correct answer unless the student already got it right.`;

        const response = await callAI(prompt);
        
        feedbackDiv.style.display = 'block';
        feedbackDiv.className = 'feedback-display info';
        
        // Process the response to ensure LaTeX rendering
        const processedResponse = response.replace(/\$([^$]+)\$/g, (match, p1) => {
            return `$${p1}$`;
        });
        
        feedbackDiv.innerHTML = `
            <div class="feedback-section">
                <strong>AI Feedback:</strong><br>
                ${processedResponse}
            </div>
        `;
        
        // Typeset math in the feedback
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise([feedbackDiv]);
        }
        
    } catch (error) {
        console.error('AI challenge failed:', error);
        feedbackDiv.style.display = 'block';
        feedbackDiv.className = 'feedback-display error';
        feedbackDiv.innerHTML = `
            <strong>AI temporarily unavailable.</strong><br>
            ${getHelpfulHintAlternatives(state.currentStatementType, problem)}
        `;
    }
    
    challengeBtn.disabled = false;
    challengeBtn.textContent = 'Challenge AI';
}

// AI API integration
async function callAI(prompt, maxRetries = 2) {
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
            if (attempt > 0) {
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
            
            const response = await fetch('/api/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ role: "user", parts: [{ text: prompt }] }] 
                })
            });
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) {
                throw new Error('Empty response from AI');
            }
            
            return text;
            
        } catch (error) {
            console.error(`AI attempt ${attempt + 1} failed:`, error);
            if (attempt === maxRetries) {
                throw error;
            }
        }
    }
}

function extractJSON(text) {
    try {
        // Try direct JSON parse first
        return JSON.parse(text);
    } catch {
        // Try to find JSON in the response
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error('No JSON found in response');
        }
        
        const cleaned = jsonMatch[0]
            .replace(/```json\s*/g, '')
            .replace(/```\s*/g, '')
            .trim();
        
        try {
            return JSON.parse(cleaned);
        } catch (e) {
            throw new Error('Invalid JSON format');
        }
    }
}

function validateProblem(data) {
    // Validate required fields
    const required = [
        'statement', 
        'alternative', 
        'preferredStrategy', 
        'hint', 
        'directProof', 
        'contradictionProof', 
        'steps'
    ];
    
    for (const field of required) {
        if (!(field in data)) {
            throw new Error(`Missing required field: ${field}`);
        }
    }
    
    // Validate nested fields
    if (!data.directProof.assumption || !data.directProof.conclusion) {
        throw new Error('Missing direct proof fields');
    }
    
    if (!data.contradictionProof.assumption || !data.contradictionProof.contradiction) {
        throw new Error('Missing contradiction proof fields');
    }
    
    // Validate steps is an array with at least 3 elements
    if (!Array.isArray(data.steps) || data.steps.length < 3) {
        throw new Error('Steps must be an array with at least 3 elements');
    }
    
    return data;
}

// Proof Builder (Tab 3)
async function generateProblem() {
    const type = document.getElementById('statement-type').value;
    const area = document.getElementById('subject-area').value;
    const btn = document.querySelector('.generate-btn');
    
    btn.disabled = true;
    btn.textContent = 'Generating...';
    
    // Reset attempt counter for builder
    state.attemptCounts.builder = 0;
    
    // Build the key from user's selection
    const key = `${type}-${area}`;
    
    // Try AI generation first
    try {
        const typeDescriptions = {
            'bare': 'a simple statement P (like "‚àö2 is irrational")',
            'implication': 'an if-then statement P‚ÜíQ (like "if n is even, then n¬≤ is even")',
            'universal': 'a universal statement ‚àÄx P(x) (like "for all integers n, n¬≤ ‚â• 0")',
            'existence': 'an existence statement ‚àÉx P(x) (like "there exists a prime between 10 and 20")'
        };
        
        const areaDescriptions = {
            'number-theory': 'number theory (integers, primes, divisibility, rational/irrational numbers)',
            'geometry': 'geometry (triangles, circles, angles, areas)',
            'algebra': 'algebra (equations, inequalities, polynomials)',
            'analysis': 'real analysis (limits, continuity, sequences, convergence)'
        };
        
        const prompt = `Generate a mathematical proof problem.
            
Statement type: ${typeDescriptions[type]}
Subject area: ${areaDescriptions[area]}

The statement should be TRUE and suitable for proof. Create a problem that's interesting but not too complex.

Return ONLY a valid JSON object with this exact structure:
{
  "statement": "The mathematical statement to prove (use $ for inline LaTeX math)",
  "alternative": "What to assume for proof by contradiction (the negation of the statement)",
  "preferredStrategy": "direct" or "contradiction" (which approach works better),
  "hint": "A helpful hint for solving the problem",
  "directProof": {
    "assumption": "Starting point/given for direct proof",
    "conclusion": "What we conclude (typically 'Therefore [statement]')"
  },
  "contradictionProof": {
    "assumption": "What we assume for contradiction (typically 'Assume [negation]')",
    "contradiction": "The contradiction we reach (end with '- Contradiction!')"
  },
  "steps": [
    "First step of the proof",
    "Second step",
    "Third step",
    "Fourth step",
    "Fifth step",
    "Sixth step (if needed)"
  ]
}

Important requirements:
- The steps array should contain 4-6 logical steps that lead from assumption to conclusion
- Each step should be one clear sentence
- Use LaTeX notation with $ for math expressions
- The proof should be mathematically correct
- Don't include "Therefore" or conclusion statements in the steps array
- Make the problem appropriate for undergraduate mathematics

Example for reference:
For "bare statement" in "number theory", you might generate a problem about ‚àö5 being irrational, or about infinitely many primes of a certain form.

RESPOND WITH ONLY THE JSON OBJECT, NO ADDITIONAL TEXT.`;

        const response = await callAI(prompt);
        const parsed = extractJSON(response);
        state.currentProblem = validateProblem(parsed);
        
        console.log('AI generated problem:', state.currentProblem);
        
    } catch (error) {
        console.error('AI generation failed:', error);
        
        // Use fallback problems based on user's selection
        if (sampleProblems[key]) {
            state.currentProblem = sampleProblems[key];
        } else {
            // If exact combination doesn't exist, try to find closest match
            const fallbackKey = Object.keys(sampleProblems).find(k => 
                k.includes(type) || k.includes(area)
            );
            state.currentProblem = sampleProblems[fallbackKey] || sampleProblems['bare-number-theory'];
        }
        
        // Show subtle notification that fallback is being used
        const notification = document.createElement('div');
        notification.className = 'warning-notice';
        notification.innerHTML = 'Using pre-loaded problem (AI temporarily unavailable)';
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '2000';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
    
    // Display the problem
    document.getElementById('theorem-text').innerHTML = state.currentProblem.statement;
    document.getElementById('current-problem').classList.add('active');
    
    // Reset UI
    resetBuilderUI();
    
    btn.disabled = false;
    btn.textContent = 'Generate Problem with AI';
    
    // Typeset math
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
    }
}

function resetBuilderUI() {
    // Clear selections
    document.querySelectorAll('.strategy-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Hide sections
    document.getElementById('alternative-section').classList.remove('active');
    document.getElementById('proof-construction').classList.remove('active');
    document.getElementById('complete-proof').classList.remove('active');
    document.getElementById('strategy-feedback').style.display = 'none';
    document.getElementById('builder-alternative-feedback').style.display = 'none';
    document.getElementById('proof-feedback').style.display = 'none';
    
    // Reset input and buttons
    document.getElementById('builder-alternative-input').value = '';
    document.getElementById('builder-alternative-input').disabled = false;
    const quickCheckBtn = document.getElementById('quick-check-btn');
    if (quickCheckBtn) quickCheckBtn.style.display = 'inline-block';
    document.getElementById('alternative-actions').style.display = 'none';
    
    state.selectedStrategy = null;
    state.attemptCounts.builder = 0;
}

function selectBuilderStrategy(strategy) {
    state.selectedStrategy = strategy;
    
    // Update buttons
    document.querySelectorAll('.strategy-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    event.target.closest('.strategy-btn').classList.add('selected');
    
    // Show feedback
    const feedback = document.getElementById('strategy-feedback');
    feedback.style.display = 'flex';
    
    if (strategy === state.currentProblem.preferredStrategy) {
        feedback.className = 'feedback-display success';
        feedback.innerHTML = '<strong>Excellent choice!</strong><br>This approach works well for this statement.';
    } else {
        feedback.className = 'feedback-display info';
        feedback.innerHTML = '<strong>Good thinking!</strong><br>This approach can work too. Let\'s proceed!';
    }
    
    // Show next step
    if (strategy === 'contradiction') {
        document.getElementById('alternative-section').classList.add('active');
        document.getElementById('builder-alternative-input').value = '';
        document.getElementById('builder-alternative-input').disabled = false;
        document.getElementById('builder-alternative-feedback').style.display = 'none';
        document.getElementById('alternative-actions').style.display = 'none';
        const quickCheckBtn = document.getElementById('quick-check-btn');
        if (quickCheckBtn) quickCheckBtn.style.display = 'inline-block';
        state.attemptCounts.builder = 0; // Reset attempts for new section
    } else {
        document.getElementById('alternative-section').classList.remove('active');
        buildProofStructure();
    }
}

// Proof Builder Alternative Check Functions
function checkBuilderAlternative() {
    const input = document.getElementById('builder-alternative-input').value.trim();
    const feedback = document.getElementById('builder-alternative-feedback');
    const actionsDiv = document.getElementById('alternative-actions');
    
    if (!input) {
        feedback.style.display = 'flex';
        feedback.className = 'feedback-display info';
        feedback.innerHTML = '<strong>Please enter your answer first!</strong>';
        actionsDiv.style.display = 'none';
        return;
    }
    
    state.attemptCounts.builder++;
    const attemptCount = state.attemptCounts.builder;
    
    // Keep input active - never disable it
    const inputField = document.getElementById('builder-alternative-input');
    inputField.disabled = false;
    
    feedback.style.display = 'flex';
    actionsDiv.style.display = 'flex';
    
    // Hide quick check button after first check
    const quickCheckBtn = document.getElementById('quick-check-btn');
    if (quickCheckBtn) {
        quickCheckBtn.style.display = 'none';
    }
    
    // Analyze the answer
    const inputLower = input.toLowerCase();
    const correctLower = state.currentProblem.alternative.toLowerCase();
    
    // Check for correctness
    const keyWords = correctLower.split(' ').filter(word => word.length > 3);
    const matchCount = keyWords.filter(word => inputLower.includes(word)).length;
    const matchRatio = keyWords.length > 0 ? matchCount / keyWords.length : 0;
    
    let isCorrect = matchRatio > 0.7;
    let isPartial = matchRatio > 0.3;
    
    // Generate specific feedback based on what they wrote and attempt number
    let feedbackHTML = '';
    
    if (isCorrect) {
        feedback.className = 'feedback-display success';
        feedbackHTML = `
            <div class="feedback-section">
                <strong>‚úÖ Excellent!</strong>
                Yes, for proof by contradiction we assume: "${state.currentProblem.alternative}"<br>
                You've correctly identified what to assume. Ready to construct the proof?
            </div>
        `;
        
        // Show only the continue button for correct answers
        actionsDiv.innerHTML = `
            <button id="continue-btn" onclick="proceedWithProof()" class="nav-btn">Continue to Proof ‚Üí</button>
        `;
        
    } else if (isPartial) {
        feedback.className = 'feedback-display info';
        
        // Progressive feedback based on attempts
        if (attemptCount === 1) {
            feedbackHTML = `
                <div class="feedback-section">
                    <strong>Good start!</strong>
                    You wrote "<em>${input}</em>" - you're on the right track!<br>
                    ${getPartialFeedback(input, state.currentProblem)}
                </div>
            `;
        } else if (attemptCount === 2) {
            feedbackHTML = `
                <div class="feedback-section">
                    <strong>Getting closer!</strong>
                    You wrote "<em>${input}</em>"<br>
                    ${getMoreSpecificFeedback(input, state.currentProblem)}
                </div>
            `;
        } else {
            feedbackHTML = `
                <div class="feedback-section">
                    <strong>You're almost there!</strong>
                    You wrote "<em>${input}</em>"<br>
                    The complete negation is: "<strong>${state.currentProblem.alternative}</strong>"<br>
                    Try to match this format exactly, or you can proceed with the proof.
                </div>
            `;
        }
        
    } else {
        feedback.className = 'feedback-display info';
        
        // Progressive feedback for incorrect answers
        if (attemptCount === 1) {
            feedbackHTML = `
                <div class="feedback-section">
                    <strong>Let's think about this differently:</strong>
                    You wrote "<em>${input}</em>"<br>
                    ${getInitialGuidance(state.currentProblem)}
                </div>
            `;
        } else if (attemptCount === 2) {
            feedbackHTML = `
                <div class="feedback-section">
                    <strong>Here's a more specific hint:</strong>
                    You wrote "<em>${input}</em>"<br>
                    ${getStructuredGuidance(state.currentProblem)}
                </div>
            `;
        } else {
            feedbackHTML = `
                <div class="feedback-section">
                    <strong>Let me help you understand:</strong>
                    The original statement is: "${state.currentProblem.statement}"<br>
                    For proof by contradiction, we assume: "<strong>${state.currentProblem.alternative}</strong>"<br>
                    This is the exact opposite of what we want to prove.
                </div>
            `;
        }
    }
    
    feedback.innerHTML = feedbackHTML + `<div class="attempt-counter">Attempt ${attemptCount}</div>`;
    
    // Show appropriate action buttons (only if not correct)
    if (!isCorrect) {
        actionsDiv.innerHTML = `
            <button onclick="checkBuilderAlternative()" class="try-again-btn">Try Again</button>
            <button onclick="getStructuredHint()" class="hint-btn">Get Hint</button>
            <button onclick="challengeAIBuilder()" class="challenge-btn">Challenge AI</button>
            <button id="show-answer-btn" onclick="showBuilderAnswer()" class="show-answer-btn" style="display: ${attemptCount >= 3 ? 'inline-block' : 'none'};">Show Answer</button>
            <button id="continue-btn" onclick="proceedWithProof()" class="nav-btn" style="display: none;">Continue to Proof ‚Üí</button>
        `;
    }
    
    // Typeset math
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([feedback]);
    }
}

function getPartialFeedback(input, problem) {
    // Context-aware feedback for partial answers
    const statementType = document.getElementById('statement-type').value;
    
    if (statementType === 'implication') {
        if (input.includes('odd') || input.includes('not even')) {
            return "You have the conclusion part right! But for implications (If P then Q), the negation needs both: 'P is true AND Q is false'.";
        }
        return "For implications, remember: the negation is 'the premise is true BUT the conclusion is false'.";
    } else if (statementType === 'universal') {
        return "You're thinking about negating 'all'. The negation of 'all' is 'there exists at least one' that doesn't satisfy the property.";
    } else if (statementType === 'existence') {
        return "To negate 'there exists', we say 'for all' or 'none exist'. Think about what that means for this specific statement.";
    }
    return "You're on the right track! Think about the exact opposite of the statement we want to prove.";
}

function getMoreSpecificFeedback(input, problem) {
    const statementType = document.getElementById('statement-type').value;
    
    if (statementType === 'implication') {
        return `For the statement "${problem.statement}", we need BOTH parts: the hypothesis must be true AND the conclusion must be false. Can you combine both parts?`;
    } else if (statementType === 'universal') {
        return `The statement says "all" or "every". To negate it, we need "there exists at least one" counterexample. What would that counterexample be?`;
    } else if (statementType === 'existence') {
        return `The statement says "there exists". To negate it, we need "for all" or "none". How would you express that none exist?`;
    }
    return `The exact negation of "${problem.statement}" would be to assume the complete opposite. What's the opposite of this claim?`;
}

function getInitialGuidance(problem) {
    const statementType = document.getElementById('statement-type').value;
    const typeGuidance = {
        'bare': "For a simple statement P, the negation is just 'not P'. What's the opposite of the given statement?",
        'implication': "For 'If P then Q', the negation is 'P is true AND Q is false'. Identify both parts.",
        'universal': "For 'All x have property P', the negation is 'There exists at least one x without property P'.",
        'existence': "For 'There exists x with property P', the negation is 'All x do NOT have property P'."
    };
    return typeGuidance[statementType] || "Think about what would make the original statement false.";
}

function getStructuredGuidance(problem) {
    const statementType = document.getElementById('statement-type').value;
    
    if (statementType === 'implication' && problem.statement.includes('even')) {
        return "The statement is 'If n is even, then n¬≤ is even'. The negation is: 'n IS even AND n¬≤ is NOT even'. Try writing this more concisely.";
    } else if (statementType === 'bare') {
        return `If we want to prove "${problem.statement}" by contradiction, we assume the opposite. What's the opposite of this property?`;
    }
    return `Look at the structure: "${problem.statement}". The negation has a specific logical form. Try to match that structure.`;
}

function getStructuredHint() {
    const feedback = document.getElementById('builder-alternative-feedback');
    const statementType = document.getElementById('statement-type').value;
    
    const hints = {
        'bare': `<strong>Structured Hint:</strong><br>
                Statement: ${state.currentProblem.statement}<br>
                Pattern: To negate P, assume ¬¨P<br>
                Think: What's the direct opposite?`,
        'implication': `<strong>Structured Hint:</strong><br>
                       Statement: ${state.currentProblem.statement}<br>
                       Pattern: To negate (P ‚Üí Q), assume (P ‚àß ¬¨Q)<br>
                       Think: "The premise holds BUT the conclusion fails"`,
        'universal': `<strong>Structured Hint:</strong><br>
                     Statement: ${state.currentProblem.statement}<br>
                     Pattern: To negate (‚àÄx P(x)), assume (‚àÉx ¬¨P(x))<br>
                     Think: "Find one counterexample"`,
        'existence': `<strong>Structured Hint:</strong><br>
                     Statement: ${state.currentProblem.statement}<br>
                     Pattern: To negate (‚àÉx P(x)), assume (‚àÄx ¬¨P(x))<br>
                     Think: "None exist" or "All fail to have the property"`
    };
    
    feedback.style.display = 'flex';
    feedback.className = 'feedback-display info';
    feedback.innerHTML = `
        <div class="hint-progression">
            ${hints[statementType]}
        </div>
    `;
    
    // Typeset math
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([feedback]);
    }
}

function showBuilderAnswer() {
    const feedback = document.getElementById('builder-alternative-feedback');
    const actionsDiv = document.getElementById('alternative-actions');
    
    feedback.className = 'feedback-display success';
    feedback.innerHTML = `
        <div class="correct-answer-reveal">
            <strong>The correct alternative is:</strong><br>
            "${state.currentProblem.alternative}"<br><br>
            This is what we assume for proof by contradiction. Now let's construct the proof!
        </div>
    `;
    
    // Update actions to only show continue
    actionsDiv.innerHTML = `
        <button id="continue-btn" onclick="proceedWithProof()" class="nav-btn">Continue to Proof ‚Üí</button>
    `;
    
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([feedback]);
    }
}

function proceedWithProof() {
    buildProofStructure();
}

async function challengeAIBuilder() {
    const input = document.getElementById('builder-alternative-input').value.trim();
    const feedback = document.getElementById('builder-alternative-feedback');
    const challengeBtn = document.querySelector('.challenge-btn');
    
    if (!input) {
        feedback.style.display = 'flex';
        feedback.className = 'feedback-display info';
        feedback.innerHTML = '<strong>Please enter your answer first!</strong>';
        return;
    }
    
    challengeBtn.disabled = true;
    challengeBtn.textContent = 'AI Analyzing...';
    
    try {
        const prompt = `You are a supportive mathematics tutor. The student is learning proof by contradiction and needs to identify what to assume.

Original statement to prove: "${state.currentProblem.statement}"
Student's proposed assumption: "${input}"
Correct assumption for contradiction: "${state.currentProblem.alternative}"
Attempt number: ${state.attemptCounts.builder}

Analyze their answer and provide guided feedback:

If completely correct: Celebrate their understanding!
If partially correct (has key ideas but not complete): 
- Acknowledge what they got right specifically
- Give ONE specific hint about what's missing WITHOUT revealing the answer
- Encourage them to modify their answer and try again

If incorrect:
- Acknowledge their effort
- Give a hint about the logical structure without giving the answer
- Focus on one specific aspect they should think about

Use $ for LaTeX math notation where appropriate.
Be encouraging and pedagogical. Reference their specific input.
Keep response to 2-3 sentences maximum.
End with an encouraging prompt to try again if they're not correct yet.`;

        const response = await callAI(prompt);
        
        feedback.style.display = 'flex';
        
        // Process response for LaTeX
        const processedResponse = response.replace(/\$([^$]+)\$/g, (match, p1) => {
            return `$${p1}$`;
        });
        
        // Check if response indicates success
        const isSuccess = response.toLowerCase().includes('correct') && 
                        (response.toLowerCase().includes('excellent') || 
                        response.toLowerCase().includes('perfect') ||
                        response.toLowerCase().includes('exactly right'));
        
        if (isSuccess) {
            feedback.className = 'feedback-display success';
            feedback.innerHTML = `
                <div class="feedback-section">
                    <strong>AI Feedback:</strong><br>
                    ${processedResponse}
                </div>
            `;
            
            // Update actions for success
            const actionsDiv = document.getElementById('alternative-actions');
            actionsDiv.innerHTML = `
                <button id="continue-btn" onclick="proceedWithProof()" class="nav-btn">Continue to Proof ‚Üí</button>
            `;
        } else {
            feedback.className = 'feedback-display info';
            feedback.innerHTML = `
                <div class="feedback-section">
                    <strong>AI Feedback:</strong><br>
                    ${processedResponse}
                </div>
                <div class="attempt-counter">AI consulted after ${state.attemptCounts.builder} attempts</div>
            `;
        }
        
        // Typeset math
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise([feedback]);
        }
        
    } catch (error) {
        console.error('AI challenge failed:', error);
        feedback.style.display = 'flex';
        feedback.className = 'feedback-display error';
        feedback.innerHTML = `
            <strong>AI temporarily unavailable.</strong><br>
            Try using the "Get Hint" button for structured guidance, or keep trying on your own!
        `;
    }
    
    challengeBtn.disabled = false;
    challengeBtn.textContent = 'Challenge AI';
}

// Proof Construction Functions
function buildProofStructure() {
    const construction = document.getElementById('proof-construction');
    construction.classList.add('active');
    
    // Set title
    const title = state.selectedStrategy === 'contradiction' ?
        'Step 3: Construct the Proof by Contradiction' :
        'Step 2: Construct the Direct Proof';
    document.getElementById('construction-title').textContent = title;
    
    // Build structure
    const structure = document.getElementById('proof-structure');
    structure.innerHTML = '';
    
    if (state.selectedStrategy === 'contradiction') {
        // Contradiction proof structure: 4 boxes
        structure.innerHTML = `
            <div class="proof-box assumption">
                <div class="box-label">Assumption for Contradiction</div>
                <div class="statement-display">${state.currentProblem.contradictionProof.assumption}</div>
            </div>
            
            <div class="proof-box steps-container">
                <div class="box-label">Proof Steps (arrange in correct order)</div>
                <div class="sortable-area" id="steps-area"></div>
            </div>
            
            <div class="proof-box contradiction">
                <div class="box-label">Derive Contradiction</div>
                <div class="statement-display">${state.currentProblem.contradictionProof.contradiction}</div>
            </div>
            
            <div class="proof-box conclusion">
                <div class="box-label">Therefore</div>
                <div class="statement-display">${state.currentProblem.statement} ‚úì</div>
            </div>
        `;
    } else {
        // Direct proof structure: 3 boxes
        structure.innerHTML = `
            <div class="proof-box given">
                <div class="box-label">Given/Assumption</div>
                <div class="statement-display">${state.currentProblem.directProof.assumption}</div>
            </div>
            
            <div class="proof-box steps-container">
                <div class="box-label">Proof Steps (arrange in correct order)</div>
                <div class="sortable-area" id="steps-area"></div>
            </div>
            
            <div class="proof-box conclusion">
                <div class="box-label">Therefore</div>
                <div class="statement-display">${state.currentProblem.directProof.conclusion}</div>
            </div>
        `;
    }
    
    // Add steps
    populateSteps();
    
    // Typeset math
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([structure]);
    }
}

function populateSteps() {
    const area = document.getElementById('steps-area');
    if (!area) return;
    
    // Store original order
    state.originalStepsOrder = [...state.currentProblem.steps];
    
    // Shuffle steps
    const shuffled = [...state.currentProblem.steps].sort(() => Math.random() - 0.5);
    
    // Create step elements
    area.innerHTML = '';
    shuffled.forEach((step, i) => {
        const div = document.createElement('div');
        div.className = 'proof-step';
        div.draggable = true;
        div.innerHTML = step;
        div.dataset.originalIndex = state.originalStepsOrder.indexOf(step);
        
        // Drag events
        div.addEventListener('dragstart', handleDragStart);
        div.addEventListener('dragend', handleDragEnd);
        div.addEventListener('dragover', handleDragOver);
        div.addEventListener('drop', handleDrop);
        
        area.appendChild(div);
    });
    
    // Typeset math in steps
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([area]);
    }
}

// Drag and drop handlers
function handleDragStart(e) {
    state.draggedElement = e.target;
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    const area = document.getElementById('steps-area');
    const afterElement = getDragAfterElement(area, e.clientY);
    if (afterElement == null) {
        area.appendChild(state.draggedElement);
    } else {
        area.insertBefore(state.draggedElement, afterElement);
    }
}

function handleDrop(e) {
    e.preventDefault();
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.proof-step:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Check proof
function checkProof() {
    const steps = document.querySelectorAll('#steps-area .proof-step');
    let correct = true;
    
    steps.forEach((step, i) => {
        const originalIndex = parseInt(step.dataset.originalIndex);
        if (originalIndex === i) {
            step.classList.add('correct');
        } else {
            step.classList.remove('correct');
            correct = false;
        }
    });
    
    const feedback = document.getElementById('proof-feedback');
    feedback.style.display = 'flex';
    
    if (correct) {
        feedback.className = 'feedback-display success';
        feedback.innerHTML = '<strong>Perfect!</strong> Your proof is logically correct!';
        showCompleteProof();
    } else {
        feedback.className = 'feedback-display info';
        feedback.innerHTML = 'Not quite right. Green steps are correctly placed. Keep trying!';
    }
}

// Show complete proof
function showCompleteProof() {
    const completeProof = document.getElementById('complete-proof');
    const content = document.getElementById('proof-content');
    
    let html = `<p><strong>Theorem:</strong> ${state.currentProblem.statement}</p>`;
    
    if (state.selectedStrategy === 'contradiction') {
        html += `<p><strong>Proof by Contradiction:</strong></p>`;
        html += `<p>${state.currentProblem.contradictionProof.assumption}</p>`;
        state.currentProblem.steps.forEach(step => {
            html += `<p>${step}</p>`;
        });
        html += `<p>${state.currentProblem.contradictionProof.contradiction}</p>`;
        html += `<p>Therefore, ${state.currentProblem.statement}.</p>`;
    } else {
        html += `<p><strong>Direct Proof:</strong></p>`;
        html += `<p>${state.currentProblem.directProof.assumption}</p>`;
        state.currentProblem.steps.forEach(step => {
            html += `<p>${step}</p>`;
        });
        html += `<p>${state.currentProblem.directProof.conclusion}</p>`;
    }
    
    html += '<div class="qed">‚àé</div>';
    
    content.innerHTML = html;
    completeProof.classList.add('active');
    
    // Typeset math
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([content]);
    }
}

// Reset proof
function resetProof() {
    populateSteps();
    document.querySelectorAll('.proof-step').forEach(step => {
        step.classList.remove('correct');
    });
    document.getElementById('proof-feedback').style.display = 'none';
    document.getElementById('complete-proof').classList.remove('active');
}

// Show hint
function showHint() {
    const feedback = document.getElementById('proof-feedback');
    feedback.style.display = 'flex';
    feedback.className = 'feedback-display info';
    feedback.innerHTML = `<strong>üí° Hint:</strong> ${state.currentProblem.hint}`;
    
    // Typeset math
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([feedback]);
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
